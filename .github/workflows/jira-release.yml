name: Create Jira Release via Webhook

on:
  workflow_run:
    workflows: [Daily Release]
    types:
      - completed

permissions:
  contents: read  # Cho phép đọc thông tin release
jobs:
  send-jira-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: Get latest tag and project name
        id: get_info
        run: |
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          echo "VERSION=$LATEST_TAG" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ github.repository }}" >> $GITHUB_ENV

      - name: Extract Jira issues from CHANGELOG.MD
        id: extract_issues
        run: |
          if [ -f CHANGELOG.MD ]; then
            ISSUES=$(grep -oE '[A-Z]{2,}-[0-9]+' CHANGELOG.MD | sort -u | jq -R -s -c 'split("\n")[:-1]')
          else
            ISSUES="[]"
          fi
          echo "ISSUES=$ISSUES" >> $GITHUB_ENV

      - name: Debug release info
        run: |
          echo "Release Version: $VERSION"
          echo "Project Name: $PROJECT_NAME"
          echo "Jira Issues: $ISSUES"

      - name: Send Incoming Webhook to Jira
        run: |
          curl -X POST \
          -H "Content-type: application/json" \
          -H "X-Automation-Webhook-Token: ${{ secrets.JIRA_WEBHOOK_TOKEN }}" \
          --data '{
            "data": {
              "releaseVersion": "'"${VERSION}"'",
              "projectName": "'"${PROJECT_NAME}"'",
              "issues": '"${ISSUES}"'
            }
          }' \
          "${{ secrets.JIRA_WEBHOOK_URL }}"
